ptCloud = pcread('orig.ply');
ptCloudFull = pcread('origFull.ply');
pcshow(ptCloud);
maxDistance = 0.1;
[model,inlierIndices] = pcfitsphere(ptCloud,maxDistance);
globe = select(ptCloud,inlierIndices);
hold on;
plot(model);
title('Globe Point Cloud');
hold off;

figure(2);
pcshow(ptCloudFull);
maxDistance2 = 0.1;
[model2,inlierIndices2] = pcfitsphere(ptCloudFull,maxDistance2);
globe2 = select(ptCloudFull,inlierIndices2);
hold on;
plot(model2);
title('Globe Point Cloud');
hold off;

center = model.Center;
center2 = model2.Center;
difference = center2 - center;

figure(3);
pcshow(ptCloud);
hold on;
pcshow(ptCloudFull);
hold off;

A = [1 0 0 0; ...
     0 1 0 0; ...
     0 0 1 0; ...
     difference(1) difference(2) difference(3) 1];
tform = affine3d(A);
ptCloudOut = pctransform(ptCloud,tform);


figure(4);
pcshow(ptCloudOut);
hold on;
pcshow(ptCloudFull);
hold off;

figure(5);
model = sphereModel(horzcat(model2.Center, model.Radius));
plot(model);
hold on;
plot(model2);
hold off;


maxDistance = 5;
[model4,inlierIndices4] = pcfitsphere(ptCloud,maxDistance);
globe4 = select(ptCloud,inlierIndices4);
figure(6);
pcshow(globe4);

% ptCloudOutFull = pcdownsample(ptCloudFull,'random',0.5);
% ptCloudOutDown = pcdownsample(ptCloudOut,'random',0.5);
tform = pcregrigid(ptCloudOutDown, ptCloudOutFull);
ptCloudReg = pctransform(ptCloudOut,tform);

figure(7);
pcshow(ptCloudReg);
hold on;
pcshow(ptCloudFull);
hold off;